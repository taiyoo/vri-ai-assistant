# マイグレーションガイド (v2 から v3)

## TL;DR

- V3では、きめ細かい権限制御とBotストア機能が導入され、DynamoDBスキーマの変更が必要になります
- **移行前に、DynamoDBの会話テーブルをバックアップしてください**
- リポジトリURLを`bedrock-claude-chat`から`bedrock-chat`に更新してください
- 移行スクリプトを実行して、データを新しいスキーマに変換します
- すべてのボットと会話は、新しい権限モデルで保持されます
- **重要：移行プロセス中、移行が完了するまですべてのユーザーにアプリケーションを使用できなくなります。このプロセスは、データ量と開発環境のパフォーマンスに応じて、通常約60分かかります。**
- **重要：移行プロセス中、すべての公開済みAPIを削除する必要があります。**
- **警告：移行プロセスはすべてのボットで100％の成功を保証できません。必要に応じて手動で再作成できるよう、重要なボット設定を事前に文書化してください。**

## はじめに

### V3の新機能

V3では、Bedrock Chatに重要な拡張機能が導入されます：

1. **きめ細かい権限制御**: ユーザーグループベースの権限で、ボットへのアクセスを制御
2. **ボットストア**: 集中型マーケットプレイスでボットを共有および発見
3. **管理機能**: APIの管理、ボットを重要としてマーク、ボット使用状況の分析

これらの新機能には、DynamoDBスキーマへの変更が必要となり、既存のユーザーには移行プロセスが必要となります。

### この移行が必要な理由

新しい権限モデルとボットストア機能には、ボットデータの保存およびアクセス方法の再構築が必要でした。移行プロセスは、既存のボットと会話を新しいスキーマに変換し、すべてのデータを保持します。

> [!WARNING]
> サービス中断のお知らせ：**移行プロセス中、アプリケーションはすべてのユーザーが利用できなくなります。** メンテナンスウィンドウ中にこの移行を実行し、ユーザーがシステムにアクセスする必要がない時間帯を選択してください。移行スクリプトが正常に完了し、すべてのデータが新しいスキーマに適切に変換された後にのみ、アプリケーションが再び利用可能になります。このプロセスは、データ量と開発環境のパフォーマンスに応じて、通常約60分かかります。

> [!IMPORTANT]
> 移行を進める前に：**移行プロセスは、古いバージョンで作成されたボットや、カスタム設定を持つボットについては、100%の成功を保証できません**。重要なボット設定（指示、ナレッジソース、設定）を、手動で再作成する必要がある場合に備えて、事前に文書化してください。

## 移行プロセス

### V3におけるボットの可視性に関する重要な注意事項

V3では、**公開共有が有効なすべてのV2ボットがBot Storeで検索可能になります。** 公開されたくない機密情報を含むボットがある場合は、V3に移行する前に非公開にすることを検討してください。

### ステップ1：環境名の特定

この手順では、`{YOUR_ENV_PREFIX}`はCloudFormationスタックの名前を識別するために指定されます。[複数環境のデプロイ](../../README.md#deploying-multiple-environments)機能を使用している場合は、移行する環境の名前に置き換えてください。使用していない場合は、空の文字列に置き換えてください。

### ステップ2：リポジトリURLの更新（推奨）

リポジトリが`bedrock-claude-chat`から`bedrock-chat`に名前変更されました。ローカルリポジトリを更新してください：

```bash
# 現在のリモートURLを確認
git remote -v

# リモートURLを更新
git remote set-url origin https://github.com/aws-samples/bedrock-chat.git

# 変更を確認
git remote -v
```

### ステップ3：最新のV2バージョンであることを確認

> [!WARNING]
> V3に移行する前に、v2.10.0に更新する必要があります。**このステップをスキップすると、移行中にデータ損失が発生する可能性があります。**

移行を開始する前に、V2の最新バージョン（**v2.10.0**）を実行していることを確認してください：

```bash
# 最新のタグを取得
git fetch --tags

# 最新のV2バージョンをチェックアウト
git checkout v2.10.0

# 最新のV2バージョンをデプロイ
cd cdk
npm ci
npx cdk deploy --all
```

### ステップ4：V2 DynamoDBテーブル名の記録

CloudFormationの出力からV2 ConversationTableの名前を取得：

```bash
# V2 ConversationTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableName'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockAIAssistantStack
```

後で移行スクリプトで使用するため、このテーブル名を安全な場所に保存してください。

### ステップ5：DynamoDBテーブルのバックアップ

続行する前に、先ほど記録したテーブル名を使用して、DynamoDB ConversationTableのバックアップを作成してください：

```bash
# V2テーブルのバックアップを作成
aws dynamodb create-backup \
  --no-cli-pager \
  --backup-name "BedrockAIAssistantV2Backup-$(date +%Y%m%d)" \
  --table-name YOUR_V2_CONVERSATION_TABLE_NAME

# バックアップステータスが利用可能であることを確認
aws dynamodb describe-backup \
  --no-cli-pager \
  --query BackupDescription.BackupDetails \
  --backup-arn YOUR_BACKUP_ARN
```

### ステップ6：公開されているすべてのAPIの削除

> [!IMPORTANT]
> V3をデプロイする前に、アップグレードプロセス中のCloudFormation出力値の競合を避けるため、公開されているすべてのAPIを削除する必要があります。

1. 管理者としてアプリケーションにログイン
2. 管理セクションに移動し、「API管理」を選択
3. 公開されているすべてのAPIのリストを確認
4. 各公開APIの横にある削除ボタンをクリックして削除

APIの公開と管理の詳細については、[PUBLISH_API.md](../PUBLISH_API_ja-JP.md)、[ADMINISTRATOR.md](../ADMINISTRATOR_ja-JP.md)のドキュメンテーションを参照してください。

### ステップ7：V3をプルしてデプロイ

最新のV3コードをプルしてデプロイ：

```bash
git fetch
git checkout v3
cd cdk
npm ci
npx cdk deploy --all
```

> [!IMPORTANT]
> V3をデプロイすると、移行プロセスが完了するまで、すべてのユーザーがアプリケーションを利用できなくなります。新しいスキーマは古いデータ形式と互換性がないため、次のステップで移行スクリプトを完了するまで、ユーザーはボットや会話にアクセスできません。

### ステップ8：V3 DynamoDBテーブル名の記録

V3をデプロイした後、新しいConversationTableとBotTableの名前を取得する必要があります：

```bash
# V3 ConversationTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockAIAssistantStack

# V3 BotTableの名前を取得
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='BotTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockAIAssistantStack
```

> [!Important]
> 移行スクリプトで必要になるため、これらのV3テーブル名を、以前に保存したV2テーブル名と一緒に必ず保存してください。

### ステップ9：移行スクリプトの実行

移行スクリプトは、V2データをV3スキーマに変換します。まず、移行スクリプト`docs/migration/migrate_v2_v3.py`を編集してテーブル名とリージョンを設定します：

```python
# DynamoDBが配置されているリージョン
REGION = "ap-northeast-1" # お使いのリージョンに置き換えてください

V2_CONVERSATION_TABLE = "BedrockAIAssistantStack-DatabaseConversationTableXXXX" # ステップ4で記録した値に置き換えてください
V3_CONVERSATION_TABLE = "BedrockAIAssistantStack-DatabaseConversationTableV3XXXX" # ステップ8で記録した値に置き換えてください
V3_BOT_TABLE = "BedrockAIAssistantStack-DatabaseBotTableV3XXXXX" # ステップ8で記録した値に置き換えてください
```

次に、バックエンドディレクトリからPoetryを使用してスクリプトを実行します：

> [!NOTE]
> Pythonの要件バージョンが3.13.0以降に変更されました（将来の開発で変更される可能性があります。pyproject.tomlを参照）。別のPythonバージョンでvenvをインストールしている場合は、一度削除する必要があります。

```bash
# バックエンドディレクトリに移動
cd backend

# まだ依存関係をインストールしていない場合
poetry install

# まず、ドライラン（何が移行されるかを確認）
poetry run python ../docs/migration/migrate_v2_v3.py --dry-run

# すべてが問題なければ、実際の移行を実行
poetry run python ../docs/migration/migrate_v2_v3.py

# 移行が成功したことを確認
poetry run python ../docs/migration/migrate_v2_v3.py --verify-only
```

移行スクリプトは、現在のディレクトリに移行プロセスの詳細を記載したレポートファイルを生成します。すべてのデータが正しく移行されたことを確認するために、このファイルを確認してください。

#### 大量のデータを扱う場合

ヘビーユーザーや大量のデータを持つ環境の場合、以下のアプローチを検討してください：

1. **ユーザーごとに移行**: 大量のデータを持つユーザーの場合、一度に1人ずつ移行：

   ```bash
   poetry run python ../docs/migration/migrate_v2_v3.py --users user-id-1 user-id-2
   ```

2. **メモリに関する考慮事項**: 移行プロセスはデータをメモリにロードします。メモリ不足（OOM）エラーが発生した場合は、以下を試してください：

   - ユーザーを1人ずつ移行
   - メモリの多いマシンで移行を実行
   - ユーザーのバッチを小さく分けて移行

3. **移行の監視**: 特に大規模なデータセットの場合、生成されたレポートファイルを確認し、すべてのデータが正しく移行されたことを確認してください。

### ステップ10：アプリケーションの確認

移行後、アプリケーションを開いて以下を確認してください：

- すべてのボットが利用可能であること
- 会話が保持されていること
- 新しい権限制御が機能していること

### クリーンアップ（オプション）

移行が成功し、すべてのデータがV3で正しくアクセス可能であることを確認した後、コストを削減するためにV2会話テーブルを任意で削除できます：

```bash
# V2会話テーブルを削除（移行が成功したことを確認した後のみ）
aws dynamodb delete-table --table-name YOUR_V2_CONVERSATION_TABLE_NAME
```

> [!IMPORTANT]
> 重要なデータがすべてV3に正常に移行されたことを徹底的に確認した後にのみ、V2テーブルを削除してください。元のテーブルを削除した場合でも、移行後少なくとも数週間は、ステップ2で作成したバックアップを保持することをお勧めします。

## V3 よくある質問

### ボットアクセスと権限

**Q: 使用しているボットが削除されたり、アクセス権限が削除された場合どうなりますか？**
A: 認証はチャット時に確認されるため、即座にアクセスできなくなります。

**Q: ユーザーが削除された場合（例：従業員の退職）はどうなりますか？**
A: ユーザーIDをパーティションキー（PK）として、DynamoDBからすべてのアイテムを削除することで、データを完全に削除できます。

**Q: 重要な公開ボットの共有を無効にできますか？**
A: いいえ、管理者が最初にボットを重要でないとマークしてから、共有を無効にする必要があります。

**Q: 重要な公開ボットを削除できますか？**
A: いいえ、管理者が最初にボットを重要でないとマークしてから、削除する必要があります。

### セキュリティと実装

**Q: ボットテーブルに行レベルセキュリティ（RLS）は実装されていますか？**
A: いいえ、アクセスパターンの多様性を考慮して実装されていません。ボットにアクセスする際に認証が行われ、会話履歴と比較してメタデータの漏洩リスクは最小限と考えられています。

**Q: APIを公開するための要件は？**
A: ボットは公開されている必要があります。

**Q: すべてのプライベートボットの管理画面はありますか？**
A: 初期のV3リリースではありません。ただし、必要に応じてユーザーIDでクエリを実行してアイテムを削除することは可能です。

**Q: 検索UXを改善するためのボットタグ機能はありますか？**
A: 初期のV3リリースではありませんが、将来的にLLMベースの自動タグ付けが追加される可能性があります。

### 管理

**Q: 管理者は何ができますか？**
A: 管理者は以下のことができます：

- 公開ボットの管理（高コストボットのチェックを含む）
- APIの管理
- 公開ボットを重要としてマーク

**Q: 部分的に共有されているボットを重要としてマークできますか？**
A: いいえ、公開ボットのみをサポートしています。

**Q: ピン留めされたボットの優先順位を設定できますか？**
A: 初期リリースでは、できません。

### 認証設定

**Q: 認証の設定方法は？**
A:

1. Amazon Cognito コンソールを開き、BrChatユーザープールでユーザーグループを作成
2. 必要に応じてユーザーをグループに追加
3. BrChatで、ボット共有設定を構成する際に、アクセスを許可するユーザーグループを選択

注意：グループメンバーシップの変更には再ログインが必要です。変更はトークンの更新時に反映されますが、IDトークンの有効期間（V3のデフォルトは30分、`cdk.json`または`parameter.ts`の`tokenValidMinutes`で設定可能）中は反映されません。

**Q: システムはボットにアクセスするたびにCognitoで確認しますか？**
A: いいえ、不要な入出力操作を避けるため、JWTトークンを使用して認証が確認されます。

### 検索機能

**Q: ボット検索はセマンティック検索をサポートしていますか？**
A: いいえ、部分的なテキスト一致のみをサポートしています。セマンティック検索（例：「automobile」→「car」、「EV」、「vehicle」）は、現在のOpenSearch Serverlessの制約（2025年3月時点）により利用できません。