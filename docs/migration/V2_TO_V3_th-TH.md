# คู่มือการย้ายระบบ (จาก v2 ไปยัง v3)

## สรุปย่อ

- V3 นำเสนอการควบคุมสิทธิ์แบบละเอียดและฟังก์ชัน Bot Store ซึ่งต้องการการเปลี่ยนแปลงสคีมา DynamoDB
- **สำรองข้อมูล ConversationTable ของ DynamoDB ก่อนการย้ายข้อมูล**
- อัปเดต URL ของคลังข้อมูลจาก `bedrock-claude-chat` เป็น `bedrock-chat`
- เรียกใช้สคริปต์การย้ายข้อมูลเพื่อแปลงข้อมูลของคุณเป็นสคีมาใหม่
- บอทและการสนทนาทั้งหมดของคุณจะถูกเก็บรักษาด้วยโมเดลสิทธิ์ใหม่
- **สำคัญ: ระหว่างกระบวนการย้ายข้อมูล แอปพลิเคชันจะไม่พร้อมใช้งานสำหรับผู้ใช้ทั้งหมดจนกว่าการย้ายข้อมูลจะเสร็จสิ้น กระบวนการนี้โดยปกติจะใช้เวลาประมาณ 60 นาที ขึ้นอยู่กับปริมาณข้อมูลและประสิทธิภาพของสภาพแวดล้อมการพัฒนาของคุณ**
- **สำคัญ: API ที่เผยแพร่ทั้งหมดต้องถูกลบระหว่างกระบวนการย้ายข้อมูล**
- **คำเตือน: กระบวนการย้ายข้อมูลไม่สามารถรับประกันความสำเร็จ 100% สำหรับบอททั้งหมด โปรดบันทึกการกำหนดค่าบอทที่สำคัญก่อนการย้ายข้อมูลในกรณีที่คุณจำเป็นต้องสร้างใหม่ด้วยตนเอง**

## บทนำ

### มีอะไรใหม่ใน V3

V3 นำการปรับปรุงที่สำคัญมาสู่ Bedrock Chat:

1. **การควบคุมสิทธิ์แบบละเอียด**: ควบคุมการเข้าถึงบอทของคุณด้วยสิทธิ์ตามกลุ่มผู้ใช้
2. **Bot Store**: แชร์และค้นพบบอทผ่านตลาดกลาง
3. **คุณสมบัติการดูแลระบบ**: จัดการ API, ทำเครื่องหมายบอทเป็นสำคัญ และวิเคราะห์การใช้งานบอท

คุณสมบัติใหม่เหล่านี้ต้องการการเปลี่ยนแปลงในสคีมา DynamoDB ซึ่งจำเป็นต้องมีกระบวนการย้ายข้อมูลสำหรับผู้ใช้ปัจจุบัน

### ทำไมต้องย้ายข้อมูลนี้

รูปแบบสิทธิ์ใหม่และฟังก์ชันการทำงาน Bot Store จำเป็นต้องปรับโครงสร้างวิธีการจัดเก็บและเข้าถึงข้อมูลบอท กระบวนการย้ายข้อมูลจะแปลงบอทและการสนทนาที่มีอยู่ของคุณเป็นสคีมาใหม่โดยยังคงข้อมูลทั้งหมดของคุณ

> [!WARNING]
> ประกาศการหยุดให้บริการ: **ระหว่างกระบวนการย้ายข้อมูล แอปพลิเคชันจะไม่พร้อมใช้งานสำหรับผู้ใช้ทั้งหมด** วางแผนดำเนินการย้ายข้อมูลนี้ในช่วงเวลาบำรุงรักษาเมื่อผู้ใช้ไม่จำเป็นต้องเข้าใช้ระบบ แอปพลิเคชันจะพร้อมใช้งานอีกครั้งหลังจากสคริปต์ย้ายข้อมูลดำเนินการสำเร็จและข้อมูลทั้งหมดถูกแปลงเป็นสคีมาใหม่ กระบวนการนี้ใช้เวลาประมาณ 60 นาที ขึ้นอยู่กับปริมาณข้อมูลและประสิทธิภาพของสภาพแวดล้อมการพัฒนาของคุณ

> [!IMPORTANT]
> ก่อนดำเนินการย้ายข้อมูล: **กระบวนการย้ายข้อมูลไม่สามารถรับประกันความสำเร็จ 100% สำหรับบอตทั้งหมด** โดยเฉพาะอย่างยิ่งบอตที่สร้างด้วยเวอร์ชันเก่าหรือมีการกำหนดค่าแบบกำหนดเอง โปรดบันทึกการกำหนดค่าบอทที่สำคัญ (คำแนะนำ แหล่งความรู้ การตั้งค่า) ก่อนเริ่มกระบวนการย้ายข้อมูลในกรณีที่คุณจำเป็นต้องสร้างใหม่ด้วยตนเอง

## กระบวนการย้ายข้อมูล

### ประกาศสำคัญเกี่ยวกับการมองเห็นบอทใน V3

ใน V3 **บอททั้งหมดของ v2 ที่เปิดการแชร์สาธารณะจะสามารถค้นหาได้ในร้านค้าบอท** หากคุณมีบอทที่มีข้อมูลที่ละเอียดอ่อนซึ่งคุณไม่ต้องการให้ค้นพบ ให้พิจารณาทำให้เป็นส่วนตัวก่อนย้ายไปยัง V3

### ขั้นตอนที่ 1: ระบุชื่อสภาพแวดล้อมของคุณ

ในขั้นตอนนี้ `{YOUR_ENV_PREFIX}` ถูกระบุเพื่อระบุชื่อของ CloudFormation Stacks ของคุณ หากคุณกำลังใช้คุณสมบัติ [การปรับใช้หลายสภาพแวดล้อม](../../README.md#deploying-multiple-environments) ให้แทนที่ด้วยชื่อของสภาพแวดล้อมที่จะย้าย หากไม่ใช่ ให้แทนที่ด้วยสตริงว่าง

### ขั้นตอนที่ 2: อัปเดต URL ที่เก็บ (แนะนำ)

ที่เก็บได้ถูกเปลี่ยนชื่อจาก `bedrock-claude-chat` เป็น `bedrock-chat` อัปเดตที่เก็บภายในเครื่องของคุณ:

```bash
# ตรวจสอบ URL รีโมตปัจจุบันของคุณ
git remote -v

# อัปเดต URL รีโมต
git remote set-url origin https://github.com/aws-samples/bedrock-chat.git

# ตรวจสอบการเปลี่ยนแปลง
git remote -v
```

### ขั้นตอนที่ 3: ตรวจสอบให้แน่ใจว่าคุณอยู่ในเวอร์ชันล่าสุดของ V2

> [!คำเตือน]
> คุณ ต้องอัปเดตเป็น v2.10.0 ก่อนย้ายไปยัง V3 **การข้ามขั้นตอนนี้อาจทำให้เกิดการสูญเสียข้อมูลระหว่างการย้าย**

ก่อนเริ่มการย้าย ให้ตรวจสอบให้แน่ใจว่าคุณกำลังรันเวอร์ชันล่าสุดของ V2 (**v2.10.0**) เพื่อให้แน่ใจว่ามีการแก้ไขข้อบกพร่องและการปรับปรุงที่จำเป็นก่อนอัปเกรดเป็น V3:

```bash
# ดึง tags ล่าสุด
git fetch --tags

# สลับไปยังเวอร์ชัน V2 ล่าสุด
git checkout v2.10.0

# ปรับใช้เวอร์ชัน V2 ล่าสุด
cd cdk
npm ci
npx cdk deploy --all
```

### ขั้นตอนที่ 4: บันทึกชื่อตาราง DynamoDB V2 ของคุณ

รับชื่อตาราง ConversationTable จาก CloudFormation outputs:

```bash
# รับชื่อตาราง ConversationTable ของ V2
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableName'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockAIAssistantStack
```

ตรวจสอบให้แน่ใจว่าบันทึกชื่อตารางนี้ในตำแหน่งที่ปลอดภัย เนื่องจากคุณจะต้องใช้ในสคริปต์ย้ายข้อมูลในภายหลัง

### ขั้นตอนที่ 5: สำรองข้อมูลตาราง DynamoDB

ก่อนดำเนินการต่อ ให้สร้างสำเนาสำรองของ ConversationTable DynamoDB โดยใช้ชื่อที่คุณเพิ่งบันทึก:

```bash
# สร้างสำเนาสำรองของตาราง V2
aws dynamodb create-backup \
  --no-cli-pager \
  --backup-name "BedrockAIAssistantV2Backup-$(date +%Y%m%d)" \
  --table-name YOUR_V2_CONVERSATION_TABLE_NAME

# ตรวจสอบสถานะสำรองเป็นพร้อมใช้งาน
aws dynamodb describe-backup \
  --no-cli-pager \
  --query BackupDescription.BackupDetails \
  --backup-arn YOUR_BACKUP_ARN
```

### ขั้นตอนที่ 6: ลบ APIs ที่เผยแพร่ทั้งหมด

> [!สำคัญ]
> ก่อนปรับใช้ V3 คุณต้องลบ APIs ที่เผยแพร่ทั้งหมดเพื่อหลีกเลี่ยงความขัดแย้งของค่าเอาต์พุต Cloudformation ระหว่างกระบวนการอัปเกรด

1. เข้าสู่ระบบแอปพลิเคชันของคุณในฐานะผู้ดูแลระบบ
2. ไปที่ส่วนผู้ดูแลระบบและเลือก "การจัดการ API"
3. ตรวจสอบรายการ APIs ที่เผยแพร่ทั้งหมด
4. ลบ API แต่ละรายการโดยคลิกปุ่มลบที่อยู่ถัดจากมัน

คุณสามารถค้นหาข้อมูลเพิ่มเติมเกี่ยวกับการเผยแพร่และการจัดการ API ได้ใน [PUBLISH_API.md](../PUBLISH_API_th-TH.md), [ADMINISTRATOR.md](../ADMINISTRATOR_th-TH.md)

### ขั้นตอนที่ 7: ดึง V3 และปรับใช้

ดึงโค้ด V3 ล่าสุดและปรับใช้:

```bash
git fetch
git checkout v3
cd cdk
npm ci
npx cdk deploy --all
```

> [!สำคัญ]
> เมื่อคุณปรับใช้ V3 แอปพลิเคชันจะไม่สามารถใช้งานได้สำหรับผู้ใช้ทั้งหมดจนกว่ากระบวนการย้ายจะเสร็จสิ้น สคีมาใหม่ไม่เข้ากันกับรูปแบบข้อมูลเก่า ดังนั้นผู้ใช้จะไม่สามารถเข้าถึงบอทหรือการสนทนาของพวกเขาจนกว่าคุณจะดำเนินการสคริปต์ย้ายข้อมูลในขั้นตอนถัดไปให้เสร็จสิ้น

### ขั้นตอนที่ 8: บันทึกชื่อตาราง DynamoDB V3 ของคุณ

หลังจากปรับใช้ V3 คุณต้องรับทั้งชื่อตาราง ConversationTable และ BotTable ใหม่:

```bash
# รับชื่อตาราง ConversationTable ของ V3
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='ConversationTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockAIAssistantStack

# รับชื่อตาราง BotTable ของ V3
aws cloudformation describe-stacks \
  --output text \
  --query "Stacks[0].Outputs[?OutputKey=='BotTableNameV3'].OutputValue" \
  --stack-name {YOUR_ENV_PREFIX}BedrockAIAssistantStack
```

> [!สำคัญ]
> ตรวจสอบให้แน่ใจว่าบันทึกชื่อตาราง V3 เหล่านี้พร้อมกับชื่อตารางของ V2 ที่คุณบันทึกไว้ก่อนหน้านี้ เนื่องจากคุณจะต้องใช้ทั้งหมดสำหรับสคริปต์ย้ายข้อมูล

(บทความแปลยาวมาก ต้องการให้แปลต่อหรือไม่?)

## คำถามที่พบบ่อย V3

### การเข้าถึงและสิทธิอนุญาตของบอต

**ถาม: เกิดอะไรขึ้นหากบอตที่ฉันใช้ถูกลบหรือสิทธิการเข้าถึงของฉันถูกเอาออก?**
ตอบ: การตรวจสอบการอนุญาตจะทำในขณะแชท ดังนั้นคุณจะสูญเสียการเข้าถึงทันที

**ถาม: เกิดอะไรขึ้นหากผู้ใช้ถูกลบ (เช่น พนักงานลาออก)?**
ตอบ: ข้อมูลของพวกเขาสามารถถูกลบได้อย่างสมบูรณ์โดยการลบทุกรายการจาก DynamoDB ด้วย user ID เป็นคีย์พาร์ติชัน (PK)

**ถาม: ฉันสามารถปิดการแชร์สำหรับบอตสาธารณะที่สำคัญได้หรือไม่?**
ตอบ: ไม่ได้ ผู้ดูแลต้องทำเครื่องหมายบอตว่าไม่สำคัญก่อนปิดการแชร์

**ถาม: ฉันสามารถลบบอตสาธารณะที่สำคัญได้หรือไม่?**
ตอบ: ไม่ได้ ผู้ดูแลต้องทำเครื่องหมายบอตว่าไม่สำคัญก่อนลบ

### ความปลอดภัยและการใช้งาน

**ถาม: มีการใช้งานความปลอดภัยระดับแถว (RLS) สำหรับตารางบอตหรือไม่?**
ตอบ: ไม่มี เนื่องจากความหลากหลายของรูปแบบการเข้าถึง การตรวจสอบการอนุญาตจะทำเมื่อเข้าถึงบอต และความเสี่ยงของการรั่วไหลข้อมูลเมตาถือว่าน้อยเมื่อเทียบกับประวัติการสนทนา

**ถาม: ข้อกำหนดสำหรับการเผยแพร่ API คืออะไร?**
ตอบ: บอตต้องเป็นสาธารณะ

**ถาม: จะมีหน้าจัดการสำหรับบอตส่วนตัวทั้งหมดหรือไม่?**
ตอบ: ไม่มีในการเปิดตัว V3 เริ่มแรก อย่างไรก็ตาม สามารถลบรายการได้โดยการสอบถามด้วย user ID ตามความจำเป็น

**ถาม: จะมีฟังก์ชันการติดแท็กบอตเพื่อปรับปรุงประสบการณ์การค้นหาหรือไม่?**
ตอบ: ไม่มีในการเปิดตัว V3 เริ่มแรก แต่อาจเพิ่มการติดแท็กอัตโนมัติด้วย LLM ในการอัปเดตในอนาคต

### การดูแลระบบ

**ถาม: ผู้ดูแลระบบสามารถทำอะไรได้บ้าง?**
ตอบ: ผู้ดูแลระบบสามารถ:

- จัดการบอตสาธารณะ (รวมถึงการตรวจสอบบอตที่มีค่าใช้จ่ายสูง)
- จัดการ API
- ทำเครื่องหมายบอตสาธารณะเป็นสำคัญ

**ถาม: ฉันสามารถทำบอตที่แชร์บางส่วนเป็นสำคัญได้หรือไม่?**
ตอบ: ไม่ได้ รองรับเฉพาะบอตสาธารณะเท่านั้น

**ถาม: ฉันสามารถตั้งลำดับความสำคัญสำหรับบอตที่ปักหมุดได้หรือไม่?**
ตอบ: ในการเปิดตัวเริ่มแรก ไม่สามารถทำได้

### การกำหนดค่าการอนุญาต

**ถาม: ฉันจะตั้งค่าการอนุญาตอย่างไร?**
ตอบ:

1. เปิดคอนโซล Amazon Cognito และสร้างกลุ่มผู้ใช้ใน BrChat user pool
2. เพิ่มผู้ใช้เข้าสู่กลุ่มตามความจำเป็น
3. ใน BrChat เลือกกลุ่มผู้ใช้ที่คุณต้องการอนุญาตเมื่อกำหนดค่าการแชร์บอต

หมายเหตุ: การเปลี่ยนแปลงสมาชิกกลุ่มต้องการการเข้าสู่ระบบใหม่เพื่อมีผล การเปลี่ยนแปลงจะสะท้อนในขณะรีเฟรชโทเคน แต่ไม่ในระหว่างช่วงอายุโทเคน ID (ค่าเริ่มต้น 30 นาทีใน V3 สามารถกำหนดค่าได้ด้วย `tokenValidMinutes` ใน `cdk.json` หรือ `parameter.ts`)

**ถาม: ระบบตรวจสอบกับ Cognito ทุกครั้งเมื่อเข้าถึงบอตหรือไม่?**
ตอบ: ไม่ การตรวจสอบการอนุญาตจะใช้โทเคน JWT เพื่อหลีกเลี่ยงการดำเนินการ I/O ที่ไม่จำเป็น

### ฟังก์ชันการค้นหา

**ถาม: การค้นหาบอตรองรับการค้นหาเชิงความหมายหรือไม่?**
ตอบ: ไม่ รองรับเพียงการจับคู่ข้อความบางส่วนเท่านั้น การค้นหาเชิงความหมาย (เช่น "automobile" → "car", "EV", "vehicle") ไม่พร้อมใช้งานเนื่องจากข้อจำกัดของ OpenSearch Serverless (มี.ค. 2025)