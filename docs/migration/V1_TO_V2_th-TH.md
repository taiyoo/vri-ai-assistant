# คู่มือการย้ายเวอร์ชัน (จาก v1 ไปยัง v2)

## สรุปย่อ

- **สำหรับผู้ใช้เวอร์ชัน v1.2 หรือเก่ากว่า**: อัปเกรดเป็น v1.4 และสร้างบอทใหม่โดยใช้ฐานความรู้ (KB) หลังจากช่วงเปลี่ยนผ่าน เมื่อคุณยืนยันว่าทุกอย่างทำงานได้อย่างถูกต้องกับ KB แล้ว ให้ดำเนินการอัปเกรดเป็น v2
- **สำหรับผู้ใช้เวอร์ชัน v1.3**: แม้ว่าคุณจะใช้ KB อยู่แล้ว ก็ **แนะนำอย่างยิ่ง** ให้อัปเกรดเป็น v1.4 และสร้างบอทใหม่ หากคุณยังใช้ pgvector ให้โยกย้ายโดยการสร้างบอทใหม่ด้วย KB ใน v1.4
- **สำหรับผู้ใช้ที่ต้องการใช้ pgvector ต่อไป**: ไม่แนะนำให้อัปเกรดเป็น v2 หากคุณวางแผนที่จะใช้ pgvector ต่อไป การอัปเกรดเป็น v2 จะลบทรัพยากรที่เกี่ยวข้องกับ pgvector ทั้งหมด และการสนับสนุนในอนาคตจะไม่มีอีกต่อไป ในกรณีนี้ให้ใช้ v1 ต่อไป
- โปรดทราบว่า **การอัปเกรดเป็น v2 จะส่งผลให้ทรัพยากรที่เกี่ยวข้องกับ Aurora ถูกลบทั้งหมด** การอัปเดตในอนาคตจะมุ่งเน้นไปที่ v2 โดยเฉพาะ และ v1 จะถูกยกเลิกการใช้งาน

## บทนำ

### สิ่งที่จะเกิดขึ้น

การอัปเดต v2 นำเสนอการเปลี่ยนแปลงครั้งใหญ่โดยการแทนที่ pgvector บน Aurora Serverless และการฝังบน ECS ด้วย [Amazon Bedrock Knowledge Bases](https://docs.aws.amazon.com/bedrock/latest/userguide/knowledge-base.html) การเปลี่ยนแปลงนี้ไม่สามารถใช้งานร่วมกับเวอร์ชันก่อนหน้าได้

### เหตุผลที่คลังข้อมูลนี้ได้นำ Knowledge Bases มาใช้และยกเลิก pgvector

มีหลายเหตุผลสำหรับการเปลี่ยนแปลงนี้:

#### การปรับปรุงความแม่นยำของ RAG

- Knowledge Bases ใช้ OpenSearch Serverless เป็นแบ็กเอนด์ ช่วยให้สามารถค้นหาแบบผสมผสานด้วยการค้นหาข้อความเต็มรูปแบบและการค้นหาเวกเตอร์ ซึ่งนำไปสู่ความแม่นยำที่ดีขึ้นในการตอบคำถามที่มีชื่อเฉพาะ ซึ่ง pgvector มีปัญหาในเรื่องนี้
- ยังรองรับตัวเลือกเพิ่มเติมสำหรับการปรับปรุงความแม่นยำของ RAG เช่น การแบ่งและแยกวิเคราะห์ขั้นสูง
- Knowledge Bases มีให้ใช้งานทั่วไปมาเกือบหนึ่งปีแล้วนับตั้งแต่เดือนตุลาคม 2024 พร้อมคุณสมบัติต่างๆ เช่น การคลานเว็บ การอัปเดตในอนาคตคาดว่าจะทำให้การนำฟังก์ชันขั้นสูงมาใช้ง่ายขึ้นในระยะยาว ตัวอย่างเช่น แม้ว่าคลังข้อมูลนี้ยังไม่ได้ใช้คุณสมบัติเช่นการนำเข้าจาก S3 บัคเก็ตที่มีอยู่ (ซึ่งเป็นคุณสมบัติที่ร้องขอบ่อย) ใน pgvector แต่ KB (KnowledgeBases) รองรับแล้ว

#### การบำรุงรักษา

- การตั้งค่า ECS + Aurora ปัจจุบันขึ้นอยู่กับไลบรารีจำนวนมาก รวมถึงไลบรารีสำหรับการแยกวิเคราะห์ PDF การคลานเว็บ และการดึงข้อความถอดเสียงจาก YouTube เปรียบเทียบกับโซลูชันที่จัดการแล้ว เช่น Knowledge Bases จะลดภาระการบำรุงรักษาสำหรับทั้งผู้ใช้และทีมพัฒนาคลังข้อมูล

## กระบวนการย้ายระบบ (สรุป)

เราขอแนะนำอย่างยิ่งให้อัพเกรดเป็นเวอร์ชัน 1.4 ก่อนการย้ายไปยังเวอร์ชัน 2 ใน v1.4 คุณสามารถใช้ pgvector และบอตฐานความรู้ควบคู่กันไป ซึ่งจะทำให้มีช่วงเปลี่ยนผ่านเพื่อสร้างบอต pgvector ที่มีอยู่เดิมใหม่ในฐานความรู้และตรวจสอบว่าทำงานได้ตามที่คาดหวัง แม้ว่าเอกสาร RAG จะยังคงเหมือนเดิม โปรดทราบว่าการเปลี่ยนแปลงส่วนหลังบ้านของ OpenSearch อาจทำให้ผลลัพธ์แตกต่างเล็กน้อย แต่โดยทั่วไปจะคล้ายคลึงกัน เนื่องจากความแตกต่างของอัลกอริทึมค้นหาแบบ k-NN

โดยการตั้งค่า `useBedrockKnowledgeBasesForRag` เป็น true ใน `cdk.json` คุณสามารถสร้างบอตโดยใช้ฐานความรู้ได้ อย่างไรก็ตาม บอต pgvector จะกลายเป็นแบบอ่านอย่างเดียว ซึ่งป้องกันการสร้างหรือแก้ไขบอต pgvector ใหม่

![](../imgs/v1_to_v2_readonly_bot.png)

ใน v1.4 ยังมีการแนะนำ [การควบคุมความปลอดภัยสำหรับ Amazon Bedrock](https://aws.amazon.com/jp/bedrock/guardrails/) เนื่องจากข้อจำกัดด้านภูมิภาคของฐานความรู้ บัคเก็ต S3 สำหรับอัปโหลดเอกสารจะต้องอยู่ในภูมิภาคเดียวกับ `bedrockRegion` เราแนะนำให้สำรองข้อมูลบัคเก็ตเอกสารที่มีอยู่ก่อนการอัปเดต เพื่อหลีกเลี่ยงการอัปโหลดเอกสารจำนวนมากด้วยตนเอง (เนื่องจากมีฟังก์ชันการนำเข้าบัคเก็ต S3)

## กระบวนการย้ายข้อมูล (รายละเอียด)

ขั้นตอนจะแตกต่างกันขึ้นอยู่กับว่าคุณกำลังใช้เวอร์ชัน v1.2 หรือเก่ากว่า หรือ v1.3

![](../imgs/v1_to_v2_arch.png)

### ขั้นตอนสำหรับผู้ใช้ v1.2 หรือเก่ากว่า

1. **สำรองข้อมูลบัคเก็ตเอกสารที่มีอยู่ (ไม่บังคับ แต่แนะนำ)** หากระบบของคุณกำลังทำงานอยู่ เราขอแนะนำอย่างยิ่งให้ทำขั้นตอนนี้ สำรองข้อมูลบัคเก็ตที่มีชื่อ `BedrockAIAssistantstack-documentbucketxxxx-yyyy` ตัวอย่างเช่น เราสามารถใช้ [AWS Backup](https://docs.aws.amazon.com/aws-backup/latest/devguide/s3-backups.html)

2. **อัปเดตเป็น v1.4**: ดึง tag ล่าสุด แก้ไข `cdk.json` และทำการปรับใช้ ทำตามขั้นตอนเหล่านี้:

   1. ดึง tag ล่าสุด:
      ```bash
      git fetch --tags
      git checkout tags/v1.4.0
      ```
   2. แก้ไข `cdk.json` ดังนี้:
      ```json
      {
        ...,
        "useBedrockKnowledgeBasesForRag": true,
        ...
      }
      ```
   3. ปรับใช้การเปลี่ยนแปลง:
      ```bash
      npx cdk deploy
      ```

3. **สร้างบอทใหม่**: สร้างบอทของคุณบน Knowledge Base ด้วยคำจำกัดความเดิม (เอกสาร ขนาดชัง เป็นต้น) เหมือนกับบอท pgvector หากคุณมีเอกสารปริมาณมาก การคืนค่าจากการสำรองในขั้นตอนที่ 1 จะทำให้กระบวนการนี้ง่ายขึ้น หากต้องการคืนค่า เราสามารถใช้การคืนค่าสำเนาข้ามภูมิภาค สำหรับรายละเอียดเพิ่มเติม เยี่ยมชม[ที่นี่](https://docs.aws.amazon.com/aws-backup/latest/devguide/restoring-s3.html) หากต้องการระบุบัคเก็ตที่คืนค่า ให้ตั้งค่าส่วน `S3 Data Source` ดังนี้ โครงสร้างเส้นทางคือ `s3://<ชื่อบัคเก็ต>/<ไอดีผู้ใช้>/<ไอดีบอท>/documents/` คุณสามารถตรวจสอบไอดีผู้ใช้ได้ที่ Cognito user pool และไอดีบอทบนแถบที่อยู่ในหน้าจอสร้างบอท

![](../imgs/v1_to_v2_KB_s3_source.png)

**โปรดทราบว่ามีบางคุณลักษณะที่ไม่พร้อมใช้งานบน Knowledge Bases เช่น การคลานเว็บและการสนับสนุนการถอดความ YouTube (วางแผนที่จะสนับสนุนตัวคลานเว็บ ([ปัญหา](https://github.com/aws-samples/bedrock-chat/issues/557))).** นอกจากนี้ โปรดทราบว่าการใช้ Knowledge Bases จะมีค่าใช้จ่ายสำหรับทั้ง Aurora และ Knowledge Bases ระหว่างการเปลี่ยนผ่าน

4. **ลบ APIs ที่เผยแพร่**: จำเป็นต้องเผยแพร่ APIs ทั้งหมดใหม่ก่อนปรับใช้ v2 เนื่องจาก VPC ถูกลบ หากต้องการทำเช่นนี้ คุณจะต้องลบ APIs ที่มีอยู่ก่อน การใช้[คุณลักษณะการจัดการ API ของผู้ดูแลระบบ](../ADMINISTRATOR_th-TH.md) สามารถทำให้กระบวนการนี้ง่ายขึ้น เมื่อการลบสแต็ค CloudFormation ทั้งหมด `APIPublishmentStackXXXX` เสร็จสมบูรณ์ สภาพแวดล้อมจะพร้อมใช้งาน

5. **ปรับใช้ v2**: หลังจากการเผยแพร่ v2 ดึง source ที่มี tag และปรับใช้ดังนี้ (สามารถทำได้เมื่อเผยแพร่):
   ```bash
   git fetch --tags
   git checkout tags/v2.0.0
   npx cdk deploy
   ```

> [!คำเตือน]
> หลังจากปรับใช้ v2 **บอทที่มีคำนำหน้า [ไม่รองรับ อ่านอย่างเดียว] จะถูกซ่อน** ตรวจสอบให้แน่ใจว่าคุณสร้างบอทที่จำเป็นใหม่ก่อนอัพเกรดเพื่อหลีกเลี่ยงการสูญเสียการเข้าถึง

> [!เคล็ดลับ]
> ระหว่างการอัปเดตสแต็ก คุณอาจพบข้อความซ้ำๆ เช่น: ตัวจัดการทรัพยากรส่งข้อความกลับ: "เครือข่ายย่อย 'subnet-xxx' มีการพึ่งพาและไม่สามารถลบได้" ในกรณีเช่นนี้ ไปที่ Management Console > EC2 > Network Interfaces และค้นหา BedrockAIAssistantStack ลบอินเทอร์เฟซเครือข่ายที่แสดงที่เชื่อมโยงกับชื่อนี้เพื่อช่วยให้กระบวนการปรับใช้ราบรื่นขึ้น

### ขั้นตอนสำหรับผู้ใช้ v1.3

ตามที่กล่าวมาก่อนหน้านี้ ใน v1.4 Knowledge Bases จะต้องถูกสร้างในภูมิภาค bedrockRegion เนื่องจากข้อจำกัดทางภูมิภาค ดังนั้นคุณจำเป็นต้องสร้าง KB ใหม่ หากคุณได้ทดสอบ KB ใน v1.3 แล้ว ให้สร้างบอทใหม่ใน v1.4 ด้วยคำจำกัดความเดียวกัน ทำตามขั้นตอนที่อธิบายสำหรับผู้ใช้ v1.2